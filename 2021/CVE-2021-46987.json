{
	"document": {
		"aggregate_severity": {
			"namespace": "https://access.redhat.com/security/updates/classification/",
			"text": "moderate"
		},
		"category": "csaf_vex",
		"csaf_version": "2.0",
		"distribution": {
			"text": "Copyright Â© Red Hat, Inc. All rights reserved.",
			"tlp": {
				"label": "WHITE",
				"url": "https://www.first.org/tlp/"
			}
		},
		"lang": "en",
		"notes": [
			{
				"category": "legal_disclaimer",
				"text": "This content is licensed under the Creative Commons Attribution 4.0 International License (https://creativecommons.org/licenses/by/4.0/). If you distribute this content, or a modified version of it, you must provide attribution to Red Hat Inc. and provide a link to the original.",
				"title": "Terms of Use"
			}
		],
		"publisher": {
			"category": "vendor",
			"contact_details": "https://access.redhat.com/security/team/contact/",
			"issuing_authority": "Red Hat Product Security is responsible for vulnerability handling across all Red Hat offerings.",
			"name": "Red Hat Product Security",
			"namespace": "https://www.redhat.com"
		},
		"references": [
			{
				"category": "self",
				"summary": "Canonical URL",
				"url": "https://access.redhat.com/security/data/csaf/beta/vex/2021/cve-2021-46987.json"
			}
		],
		"title": "kernel: btrfs: fix deadlock when cloning inline extents and using qgroups",
		"tracking": {
			"current_release_date": "2024-03-06T05:43:54+00:00",
			"generator": {
				"date": "2024-03-06T05:43:54+00:00",
				"engine": {
					"name": "Red Hat SDEngine",
					"version": "3.27.1"
				}
			},
			"id": "CVE-2021-46987",
			"initial_release_date": "2021-01-01T00:00:00+00:00",
			"revision_history": [
				{
					"date": "2021-01-01T00:00:00+00:00",
					"number": "1",
					"summary": "Initial version"
				},
				{
					"date": "2024-03-01T22:41:41+00:00",
					"number": "2",
					"summary": "Current version"
				},
				{
					"date": "2024-03-06T05:43:54+00:00",
					"number": "3",
					"summary": "Last generated version"
				}
			],
			"status": "final",
			"version": "3"
		}
	},
	"product_tree": {
		"branches": [
			{
				"branches": [
					{
						"category": "product_name",
						"name": "Red Hat Enterprise Linux 6",
						"product": {
							"name": "Red Hat Enterprise Linux 6",
							"product_id": "red_hat_enterprise_linux_6",
							"product_identification_helper": {
								"cpe": "cpe:/o:redhat:enterprise_linux:6"
							}
						}
					},
					{
						"category": "product_name",
						"name": "Red Hat Enterprise Linux 7",
						"product": {
							"name": "Red Hat Enterprise Linux 7",
							"product_id": "red_hat_enterprise_linux_7",
							"product_identification_helper": {
								"cpe": "cpe:/o:redhat:enterprise_linux:7"
							}
						}
					},
					{
						"category": "product_name",
						"name": "Red Hat Enterprise Linux 8",
						"product": {
							"name": "Red Hat Enterprise Linux 8",
							"product_id": "red_hat_enterprise_linux_8",
							"product_identification_helper": {
								"cpe": "cpe:/o:redhat:enterprise_linux:8"
							}
						}
					},
					{
						"category": "product_name",
						"name": "Red Hat Enterprise Linux 9",
						"product": {
							"name": "Red Hat Enterprise Linux 9",
							"product_id": "red_hat_enterprise_linux_9",
							"product_identification_helper": {
								"cpe": "cpe:/o:redhat:enterprise_linux:9"
							}
						}
					},
					{
						"category": "product_version",
						"name": "kernel",
						"product": {
							"name": "kernel",
							"product_id": "kernel"
						}
					},
					{
						"category": "product_version",
						"name": "kernel-rt",
						"product": {
							"name": "kernel-rt",
							"product_id": "kernel-rt"
						}
					}
				],
				"category": "vendor",
				"name": "Red Hat"
			}
		],
		"relationships": [
			{
				"category": "default_component_of",
				"full_product_name": {
					"name": "kernel as a component of Red Hat Enterprise Linux 6",
					"product_id": "red_hat_enterprise_linux_6:kernel"
				},
				"product_reference": "kernel",
				"relates_to_product_reference": "red_hat_enterprise_linux_6"
			},
			{
				"category": "default_component_of",
				"full_product_name": {
					"name": "kernel as a component of Red Hat Enterprise Linux 7",
					"product_id": "red_hat_enterprise_linux_7:kernel"
				},
				"product_reference": "kernel",
				"relates_to_product_reference": "red_hat_enterprise_linux_7"
			},
			{
				"category": "default_component_of",
				"full_product_name": {
					"name": "kernel-rt as a component of Red Hat Enterprise Linux 7",
					"product_id": "red_hat_enterprise_linux_7:kernel-rt"
				},
				"product_reference": "kernel-rt",
				"relates_to_product_reference": "red_hat_enterprise_linux_7"
			},
			{
				"category": "default_component_of",
				"full_product_name": {
					"name": "kernel as a component of Red Hat Enterprise Linux 8",
					"product_id": "red_hat_enterprise_linux_8:kernel"
				},
				"product_reference": "kernel",
				"relates_to_product_reference": "red_hat_enterprise_linux_8"
			},
			{
				"category": "default_component_of",
				"full_product_name": {
					"name": "kernel-rt as a component of Red Hat Enterprise Linux 8",
					"product_id": "red_hat_enterprise_linux_8:kernel-rt"
				},
				"product_reference": "kernel-rt",
				"relates_to_product_reference": "red_hat_enterprise_linux_8"
			},
			{
				"category": "default_component_of",
				"full_product_name": {
					"name": "kernel as a component of Red Hat Enterprise Linux 9",
					"product_id": "red_hat_enterprise_linux_9:kernel"
				},
				"product_reference": "kernel",
				"relates_to_product_reference": "red_hat_enterprise_linux_9"
			},
			{
				"category": "default_component_of",
				"full_product_name": {
					"name": "kernel-rt as a component of Red Hat Enterprise Linux 9",
					"product_id": "red_hat_enterprise_linux_9:kernel-rt"
				},
				"product_reference": "kernel-rt",
				"relates_to_product_reference": "red_hat_enterprise_linux_9"
			}
		]
	},
	"vulnerabilities": [
		{
			"cve": "CVE-2021-46987",
			"cwe": {
				"id": "CWE-833",
				"name": "Deadlock"
			},
			"discovery_date": "2024-02-28T00:00:00+00:00",
			"flags": [
				{
					"label": "vulnerable_code_not_present",
					"product_ids": [
						"red_hat_enterprise_linux_8:kernel",
						"red_hat_enterprise_linux_8:kernel-rt",
						"red_hat_enterprise_linux_9:kernel",
						"red_hat_enterprise_linux_9:kernel-rt"
					]
				}
			],
			"ids": [
				{
					"system_name": "Red Hat Bugzilla ID",
					"text": "2266752"
				}
			],
			"notes": [
				{
					"category": "description",
					"text": "In the Linux kernel, the following vulnerability has been resolved:\n\nbtrfs: fix deadlock when cloning inline extents and using qgroups\n\nThere are a few exceptional cases where cloning an inline extent needs to\ncopy the inline extent data into a page of the destination inode.\n\nWhen this happens, we end up starting a transaction while having a dirty\npage for the destination inode and while having the range locked in the\ndestination's inode iotree too. Because when reserving metadata space\nfor a transaction we may need to flush existing delalloc in case there is\nnot enough free space, we have a mechanism in place to prevent a deadlock,\nwhich was introduced in commit 3d45f221ce627d (\"btrfs: fix deadlock when\ncloning inline extent and low on free metadata space\").\n\nHowever when using qgroups, a transaction also reserves metadata qgroup\nspace, which can also result in flushing delalloc in case there is not\nenough available space at the moment. When this happens we deadlock, since\nflushing delalloc requires locking the file range in the inode's iotree\nand the range was already locked at the very beginning of the clone\noperation, before attempting to start the transaction.\n\nWhen this issue happens, stack traces like the following are reported:\n\n  [72747.556262] task:kworker/u81:9   state:D stack:    0 pid:  225 ppid:     2 flags:0x00004000\n  [72747.556268] Workqueue: writeback wb_workfn (flush-btrfs-1142)\n  [72747.556271] Call Trace:\n  [72747.556273]  __schedule+0x296/0x760\n  [72747.556277]  schedule+0x3c/0xa0\n  [72747.556279]  io_schedule+0x12/0x40\n  [72747.556284]  __lock_page+0x13c/0x280\n  [72747.556287]  ? generic_file_readonly_mmap+0x70/0x70\n  [72747.556325]  extent_write_cache_pages+0x22a/0x440 [btrfs]\n  [72747.556331]  ? __set_page_dirty_nobuffers+0xe7/0x160\n  [72747.556358]  ? set_extent_buffer_dirty+0x5e/0x80 [btrfs]\n  [72747.556362]  ? update_group_capacity+0x25/0x210\n  [72747.556366]  ? cpumask_next_and+0x1a/0x20\n  [72747.556391]  extent_writepages+0x44/0xa0 [btrfs]\n  [72747.556394]  do_writepages+0x41/0xd0\n  [72747.556398]  __writeback_single_inode+0x39/0x2a0\n  [72747.556403]  writeback_sb_inodes+0x1ea/0x440\n  [72747.556407]  __writeback_inodes_wb+0x5f/0xc0\n  [72747.556410]  wb_writeback+0x235/0x2b0\n  [72747.556414]  ? get_nr_inodes+0x35/0x50\n  [72747.556417]  wb_workfn+0x354/0x490\n  [72747.556420]  ? newidle_balance+0x2c5/0x3e0\n  [72747.556424]  process_one_work+0x1aa/0x340\n  [72747.556426]  worker_thread+0x30/0x390\n  [72747.556429]  ? create_worker+0x1a0/0x1a0\n  [72747.556432]  kthread+0x116/0x130\n  [72747.556435]  ? kthread_park+0x80/0x80\n  [72747.556438]  ret_from_fork+0x1f/0x30\n\n  [72747.566958] Workqueue: btrfs-flush_delalloc btrfs_work_helper [btrfs]\n  [72747.566961] Call Trace:\n  [72747.566964]  __schedule+0x296/0x760\n  [72747.566968]  ? finish_wait+0x80/0x80\n  [72747.566970]  schedule+0x3c/0xa0\n  [72747.566995]  wait_extent_bit.constprop.68+0x13b/0x1c0 [btrfs]\n  [72747.566999]  ? finish_wait+0x80/0x80\n  [72747.567024]  lock_extent_bits+0x37/0x90 [btrfs]\n  [72747.567047]  btrfs_invalidatepage+0x299/0x2c0 [btrfs]\n  [72747.567051]  ? find_get_pages_range_tag+0x2cd/0x380\n  [72747.567076]  __extent_writepage+0x203/0x320 [btrfs]\n  [72747.567102]  extent_write_cache_pages+0x2bb/0x440 [btrfs]\n  [72747.567106]  ? update_load_avg+0x7e/0x5f0\n  [72747.567109]  ? enqueue_entity+0xf4/0x6f0\n  [72747.567134]  extent_writepages+0x44/0xa0 [btrfs]\n  [72747.567137]  ? enqueue_task_fair+0x93/0x6f0\n  [72747.567140]  do_writepages+0x41/0xd0\n  [72747.567144]  __filemap_fdatawrite_range+0xc7/0x100\n  [72747.567167]  btrfs_run_delalloc_work+0x17/0x40 [btrfs]\n  [72747.567195]  btrfs_work_helper+0xc2/0x300 [btrfs]\n  [72747.567200]  process_one_work+0x1aa/0x340\n  [72747.567202]  worker_thread+0x30/0x390\n  [72747.567205]  ? create_worker+0x1a0/0x1a0\n  [72747.567208]  kthread+0x116/0x130\n  [72747.567211]  ? kthread_park+0x80/0x80\n  [72747.567214]  ret_from_fork+0x1f/0x30\n\n  [72747.569686] task:fsstress        state:D stack:    \n---truncated---",
					"title": "Vulnerability description"
				},
				{
					"category": "summary",
					"text": "kernel: btrfs: fix deadlock when cloning inline extents and using qgroups",
					"title": "Vulnerability summary"
				},
				{
					"category": "other",
					"text": "Red Hat Enterprise Linux 8 and 9 are not affected by this CVE, as they do not include Btrfs filesystem support (CONFIG_BTRFS_FS is not set).",
					"title": "Statement"
				},
				{
					"category": "general",
					"text": "The CVSS score(s) listed for this vulnerability do not reflect the associated product's status, and are included for informational purposes to better understand the severity of this vulnerability.",
					"title": "CVSS score applicability"
				}
			],
			"product_status": {
				"known_affected": [
					"red_hat_enterprise_linux_6:kernel",
					"red_hat_enterprise_linux_7:kernel",
					"red_hat_enterprise_linux_7:kernel-rt"
				],
				"known_not_affected": [
					"red_hat_enterprise_linux_8:kernel",
					"red_hat_enterprise_linux_8:kernel-rt",
					"red_hat_enterprise_linux_9:kernel",
					"red_hat_enterprise_linux_9:kernel-rt"
				]
			},
			"references": [
				{
					"category": "self",
					"summary": "Canonical URL",
					"url": "https://access.redhat.com/security/cve/CVE-2021-46987"
				},
				{
					"category": "external",
					"summary": "RHBZ#2266752",
					"url": "https://bugzilla.redhat.com/show_bug.cgi?id=2266752"
				},
				{
					"category": "external",
					"summary": "https://www.cve.org/CVERecord?id=CVE-2021-46987",
					"url": "https://www.cve.org/CVERecord?id=CVE-2021-46987"
				},
				{
					"category": "external",
					"summary": "https://nvd.nist.gov/vuln/detail/CVE-2021-46987",
					"url": "https://nvd.nist.gov/vuln/detail/CVE-2021-46987"
				},
				{
					"category": "external",
					"summary": "https://lore.kernel.org/linux-cve-announce/2024022825-CVE-2021-46987-f73f@gregkh/T/#u",
					"url": "https://lore.kernel.org/linux-cve-announce/2024022825-CVE-2021-46987-f73f@gregkh/T/#u"
				}
			],
			"release_date": "2024-02-28T00:00:00+00:00",
			"remediations": [
				{
					"category": "no_fix_planned",
					"details": "Out of support scope",
					"product_ids": [
						"red_hat_enterprise_linux_6:kernel",
						"red_hat_enterprise_linux_7:kernel",
						"red_hat_enterprise_linux_7:kernel-rt"
					]
				}
			],
			"scores": [
				{
					"cvss_v3": {
						"attackComplexity": "LOW",
						"attackVector": "LOCAL",
						"availabilityImpact": "HIGH",
						"baseScore": 5.5,
						"baseSeverity": "MEDIUM",
						"confidentialityImpact": "NONE",
						"integrityImpact": "NONE",
						"privilegesRequired": "LOW",
						"scope": "UNCHANGED",
						"userInteraction": "NONE",
						"vectorString": "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H",
						"version": "3.1"
					},
					"products": [
						"red_hat_enterprise_linux_6:kernel",
						"red_hat_enterprise_linux_7:kernel",
						"red_hat_enterprise_linux_7:kernel-rt"
					]
				}
			],
			"threats": [
				{
					"category": "impact",
					"details": "Moderate",
					"product_ids": [
						"red_hat_enterprise_linux_6:kernel",
						"red_hat_enterprise_linux_7:kernel",
						"red_hat_enterprise_linux_7:kernel-rt"
					]
				}
			],
			"title": "kernel: btrfs: fix deadlock when cloning inline extents and using qgroups"
		}
	]
}
